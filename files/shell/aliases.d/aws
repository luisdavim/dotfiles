# vim:set filetype=bash:

# AWS aliases

function ecr-login() {
  region=${AWS_DEFAULT_REGION}
  if [ -z "${region}" ]; then
    region=$(aws ec2 describe-availability-zones --output text --query 'AvailabilityZones[0].[RegionName]')
  fi
  account=$(aws sts get-caller-identity | jq -r .Account)
  aws ecr get-login-password | docker login --username AWS --password-stdin "${account}.dkr.ecr.${region}.amazonaws.com"
}

# switch AWS profiles
function actx() {
  CTX="${1}"
  if [ -z "${CTX}" ]; then
    CTX="$(aws configure list-profiles|fzf)"
  fi
  export AWS_PROFILE="${CTX}"
  aws sts get-caller-identity
}

# switch AWS regions
function actr() {
  CTX="${1}"
  if [ -z "${CTX}" ]; then
    CTX="$(aws --output json ec2 describe-regions | jq -r '.Regions[]|.RegionName'|fzf)"
  fi
  export AWS_DEFAULT_REGION="${CTX}"
}

# switch EKS contexts
function ectx() {
  CFG_DIR=~/.kube/config.d
  CTX="${1}"
  if [ -z "${CTX}" ]; then
    CTX="$(aws --output json eks list-clusters | jq -r '.clusters[]' | fzf)"
    export KUBECONFIG="${CFG_DIR}/${CTX}"
    aws eks update-kubeconfig --name "${CTX}"
  fi
}
